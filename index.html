<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no" />
<title>Flumgus; speedforce patch</title>
<style>
  body, html {
    margin: 0; 
    padding: 0; 
    overflow: hidden;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    user-select: none;
    height: 100vh;
    display: flex;
    flex-direction: column;
    touch-action: manipulation;
  }
  
  #gameContainer {
    flex: 1;
    position: relative;
    padding: 8px;
    padding-bottom: 4px;
    min-height: 200px;
  }
  
  #gameCanvas {
    background: linear-gradient(to bottom, #87ceeb 60%, #6b8e23 60%);
    display: block;
    margin: 0 auto;
    border-radius: 12px;
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    width: 100%;
    height: 100%;
    max-height: 400px;
    touch-action: none;
  }
  
  #ui {
    background: rgba(255, 255, 255, 0.95);
    backdrop-filter: blur(10px);
    padding: 12px;
    border-top: 1px solid rgba(255, 255, 255, 0.2);
    user-select: none;
    display: flex;
    flex-direction: column;
    gap: 8px;
    box-shadow: 0 -4px 20px rgba(0,0,0,0.1);
    max-height: 60vh;
    overflow-y: auto;
  }
  
  #stats {
    display: flex;
    justify-content: center;
    gap: 16px;
    font-weight: 600;
    font-size: 16px;
    color: #2d3748;
    margin-bottom: 8px;
    flex-wrap: wrap;
  }
  
  .stat-item {
    display: flex;
    align-items: center;
    gap: 6px;
    min-width: 120px;
    justify-content: center;
  }
  
  .stat-value {
    color: #4299e1;
    font-weight: 700;
  }
  
  #controls {
    display: flex;
    flex-direction: column;
    gap: 10px;
    align-items: center;
  }
  
  #mainControls {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    justify-content: center;
    width: 100%;
  }
  
  #upgradeControls {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
    max-width: 800px;
    overflow-x: hidden;
    overflow-y: auto;
    padding: 8px 0;
    scrollbar-width: none;
    max-height: 300px;
    flex-direction: column;
  }
  
  #upgradeControls::-webkit-scrollbar {
    display: none;
  }
  
  .upgrade-row {
    display: flex;
    flex-wrap: wrap;
    gap: 6px;
    width: 100%;
    justify-content: center;
  }
  
  button {
    font-family: inherit;
    padding: 8px 10px;
    font-size: 12px;
    font-weight: 600;
    cursor: pointer;
    border: none;
    border-radius: 8px;
    transition: all 0.2s ease;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    touch-action: manipulation;
    -webkit-tap-highlight-color: transparent;
    min-width: 120px;
    flex: 1;
    min-height: 40px;
    max-width: 180px;
  }
  
  button:hover, button:active {
    transform: translateY(-1px);
    box-shadow: 0 4px 12px rgba(0,0,0,0.15);
  }
  
  button:active {
    transform: translateY(0);
  }
  
  #launchBtn {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
    font-size: 16px;
    padding: 12px 20px;
    min-width: 140px;
    flex: 1;
    max-width: 200px;
  }
  
  #launchBtn:hover {
    background: linear-gradient(135deg, #38a169, #2f855a);
  }
  
  #endFlightBtn {
    background: linear-gradient(135deg, #e53e3e, #c53030);
    color: white;
    font-size: 16px;
    padding: 12px 20px;
    min-width: 140px;
    flex: 1;
    max-width: 200px;
  }
  
  #endFlightBtn:hover {
    background: linear-gradient(135deg, #c53030, #9c2626);
  }
  
  #endFlightBtn:disabled {
    background: #e2e8f0;
    color: #a0aec0;
    cursor: not-allowed;
    transform: none;
  }
  
  .upgrade-btn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
    color: white;
    text-align: left;
    position: relative;
    overflow: hidden;
    padding: 6px 8px;
    font-size: 11px;
    min-width: 120px;
    flex: 1;
    min-height: 40px;
    max-width: 180px;
  }
  
  .upgrade-btn:hover {
    background: linear-gradient(135deg, #3182ce, #2c5282);
  }
  
  .upgrade-btn:disabled {
    background: #e2e8f0;
    color: #a0aec0;
    cursor: not-allowed;
    transform: none;
  }
  
  .upgrade-btn:disabled:hover {
    transform: none;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  }

  /* Touch controls for mobile */
  #touchControls {
    position: absolute;
    bottom: 20px;
    left: 0;
    right: 0;
    display: none;
    justify-content: space-between;
    padding: 0 20px;
    pointer-events: none;
    z-index: 1000;
  }
  
  .touch-btn {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    background: rgba(255, 255, 255, 0.8);
    backdrop-filter: blur(10px);
    border: 2px solid rgba(255, 255, 255, 0.3);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    pointer-events: all;
    touch-action: manipulation;
    user-select: none;
    -webkit-tap-highlight-color: transparent;
  }
  
  .touch-btn:active {
    background: rgba(255, 255, 255, 1);
    transform: scale(0.95);
  }
  
  @media (max-width: 768px) {
    #touchControls {
      display: flex;
    }
    
    #stats {
      font-size: 14px;
      gap: 12px;
    }
    
    .stat-item {
      min-width: 100px;
    }
    
    #upgradeControls {
      gap: 4px;
      padding: 6px 0;
      max-height: 300px;
    }
    
    .upgrade-row {
      gap: 4px;
    }
    
    .upgrade-btn {
      font-size: 10px;
      padding: 5px 6px;
      min-width: 110px;
      min-height: 35px;
    }
    
    button {
      padding: 6px 8px;
      font-size: 11px;
      min-width: 110px;
      min-height: 35px;
    }
  }
  
  @media (max-width: 480px) {
    #gameContainer {
      padding: 4px;
    }
    
    #ui {
      padding: 8px;
    }
    
    #stats {
      font-size: 13px;
      gap: 8px;
    }
    
    .stat-item {
      min-width: 90px;
      font-size: 12px;
    }
    
    #upgradeControls {
      gap: 3px;
      padding: 4px 0;
      max-height: 300px;
    }
    
    .upgrade-row {
      gap: 3px;
    }
    
    .upgrade-btn {
      font-size: 9px;
      padding: 4px 5px;
      min-width: 100px;
      min-height: 30px;
    }
    
    button {
      font-size: 10px;
      padding: 5px 6px;
      min-width: 100px;
      min-height: 30px;
    }
    
    #launchBtn, #endFlightBtn {
      font-size: 14px;
      min-width: 120px;
    }
  }
  
  /* New rebirth UI */
  #rebirthModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  #rebirthModal.active {
    opacity: 1;
    pointer-events: all;
  }
  
  #rebirthContent {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    max-width: 90%;
    width: 500px;
    transform: translateY(20px);
    transition: transform 0.3s ease;
    position: relative;
  }
  
  #rebirthModal.active #rebirthContent {
    transform: translateY(0);
  }
  
  #rebirthContent h2 {
    margin-top: 0;
    color: #ffd700;
  }
  
  #rebirthContent p {
    margin: 15px 0;
    line-height: 1.6;
  }
  
  #rebirthContent button {
    background: linear-gradient(135deg, #48bb78, #38a169);
    color: white;
    border: none;
    padding: 12px 25px;
    font-size: 18px;
    border-radius: 8px;
    cursor: pointer;
    margin-top: 20px;
    transition: all 0.2s ease;
  }
  
  #rebirthContent button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  #cancelRebirthBtn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: rgba(255, 255, 255, 0.2);
    border: none;
    color: white;
    width: 30px;
    height: 30px;
    border-radius: 50%;
    font-size: 18px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  
  #cancelRebirthBtn:hover {
    background: rgba(255, 255, 255, 0.3);
    transform: scale(1.1);
  }
  
  .rebirth-boost {
    display: inline-block;
    background: rgba(255, 215, 0, 0.2);
    padding: 5px 10px;
    border-radius: 5px;
    margin: 0 5px;
    font-weight: bold;
  }
  
  /* Achievement notification */
  #achievementNotification {
    position: fixed;
    top: 20px;
    right: 20px;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #2d3748;
    padding: 12px 16px;
    border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    font-weight: 600;
    font-size: 14px;
    min-width: 250px;
    transform: translateX(300px);
    transition: transform 0.3s ease;
    z-index: 9999;
  }
  
  /* Particle effect */
  .particle {
    position: absolute;
    background: rgba(255, 255, 255, 0.7);
    border-radius: 50%;
    pointer-events: none;
    z-index: 100;
  }
  
  /* New upgrade styling */
  .upgrade-btn.special {
    background: linear-gradient(135deg, #f56565, #e53e3e);
  }
  
  .upgrade-btn.special:hover {
    background: linear-gradient(135deg, #e53e3e, #c53030);
  }
  
  .upgrade-btn.rebirth {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
  }
  
  .upgrade-btn.rebirth:hover {
    background: linear-gradient(135deg, #6b46c1, #553c9a);
  }
  
  /* Power-up items */
  .power-up {
    position: absolute;
    width: 20px;
    height: 20px;
    border-radius: 50%;
    z-index: 50;
    animation: pulse 1.5s infinite;
  }
  
  @keyframes pulse {
    0% { transform: scale(1); opacity: 0.8; }
    50% { transform: scale(1.2); opacity: 1; }
    100% { transform: scale(1); opacity: 0.8; }
  }
  
  .speed-power {
    background: linear-gradient(135deg, #ff9a9e, #fad0c4);
    box-shadow: 0 0 10px #ff9a9e;
  }
  
  .bounce-power {
    background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
    box-shadow: 0 0 10px #a1c4fd;
  }
  
  /* Stats panel */
  #statsPanel {
    background: rgba(255, 255, 255, 0.8);
    border-radius: 10px;
    padding: 10px;
    margin-top: 5px;
    display: flex;
    justify-content: space-around;
    flex-wrap: wrap;
    gap: 5px;
  }
  
  .stat-card {
    background: white;
    border-radius: 8px;
    padding: 8px 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    min-width: 100px;
    text-align: center;
  }
  
  .stat-card h3 {
    margin: 0 0 5px 0;
    font-size: 12px;
    color: #4299e1;
  }
  
  .stat-card .value {
    font-size: 16px;
    font-weight: bold;
    color: #2d3748;
  }
  
  /* Transcend mode */
  #transcendMode {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e, #16213e);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10000;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }
  
  #transcendMode.active {
    opacity: 1;
    pointer-events: all;
  }
  
  #transcendMode h1 {
    color: #ffd700;
    font-size: 3rem;
    margin-bottom: 2rem;
    text-align: center;
  }
  
  #transcendButton {
    background: linear-gradient(135deg, #805ad5, #6b46c1);
    color: white;
    border: none;
    padding: 20px 40px;
    font-size: 2rem;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
  }
  
  #transcendButton:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
  }
  
  #transcendButton:active {
    transform: scale(0.95);
  }
  
  #transcendInfo {
    color: white;
    text-align: center;
    max-width: 80%;
    margin-top: 2rem;
    font-size: 1.2rem;
    line-height: 1.6;
  }
  
  /* Win screen */
  #winScreen {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #0f9d58, #00c853);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 10001;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.5s ease;
  }
  
  #winScreen.active {
    opacity: 1;
    pointer-events: all;
  }
  
  #winScreen h1 {
    color: white;
    font-size: 4rem;
    text-align: center;
    margin-bottom: 1rem;
    text-shadow: 0 0 10px rgba(0,0,0,0.3);
  }
  
  #winScreen p {
    color: white;
    font-size: 1.5rem;
    text-align: center;
    max-width: 80%;
    margin-bottom: 2rem;
    text-shadow: 0 0 5px rgba(0,0,0,0.3);
  }
  
  #restartButton {
    background: linear-gradient(135deg, #ffd700, #ff9800);
    color: #2d3748;
    border: none;
    padding: 20px 40px;
    font-size: 1.5rem;
    border-radius: 15px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    font-weight: bold;
  }
  
  #restartButton:hover {
    transform: scale(1.05);
    box-shadow: 0 12px 30px rgba(0,0,0,0.4);
  }
  
  /* Transcend animation */
  .transcend-animation {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    pointer-events: none;
    z-index: 9999;
    display: none;
  }
  
  .transcend-snail {
    position: absolute;
    font-size: 60px;
    animation: transcend 2s forwards;
    z-index: 1000;
  }
  
  @keyframes transcend {
    0% {
      transform: translate(0, 0) scale(1);
      opacity: 1;
    }
    30% {
      transform: translate(0, -100px) scale(1.5);
      opacity: 0.8;
    }
    60% {
      transform: translate(0, -200px) scale(2);
      opacity: 0.5;
    }
    100% {
      transform: translate(0, -300px) scale(3);
      opacity: 0;
    }
  }
  
  .transcend-glow {
    position: absolute;
    width: 100px;
    height: 100px;
    border-radius: 50%;
    background: radial-gradient(circle, rgba(255,215,0,0.8) 0%, rgba(255,215,0,0) 70%);
    animation: glow 2s infinite;
    z-index: 999;
  }
  
  @keyframes glow {
    0% {
      transform: scale(0.8);
      opacity: 0.8;
    }
    50% {
      transform: scale(1.2);
      opacity: 0.4;
    }
    100% {
      transform: scale(0.8);
      opacity: 0.8;
    }
  }
  
  /* Reset progress modal */
  #resetModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.8);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10002;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  
  #resetModal.active {
    opacity: 1;
    pointer-events: all;
  }
  
  #resetContent {
    background: linear-gradient(135deg, #2d3748, #1a202c);
    color: white;
    padding: 30px;
    border-radius: 15px;
    text-align: center;
    max-width: 90%;
    width: 500px;
    transform: translateY(20px);
    transition: transform 0.3s ease;
    position: relative;
  }
  
  #resetContent h2 {
    margin-top: 0;
    color: #ff6b6b;
  }
  
  #resetContent p {
    margin: 15px 0;
    line-height: 1.6;
  }
  
  #resetContent button {
    background: linear-gradient(135deg, #e53e3e, #c53030);
    color: white;
    border: none;
    padding: 12px 25px;
    font-size: 18px;
    border-radius: 8px;
    cursor: pointer;
    margin: 10px 10px;
    transition: all 0.2s ease;
  }
  
  #resetContent button:hover {
    transform: scale(1.05);
    box-shadow: 0 4px 15px rgba(0,0,0,0.2);
  }
  
  #cancelResetBtn {
    background: linear-gradient(135deg, #4299e1, #3182ce);
  }
  
  #confirmResetBtn {
    background: linear-gradient(135deg, #e53e3e, #c53030);
  }
</style>
</head>
<body>

<div id="gameContainer">
  <canvas id="gameCanvas" width="800" height="400"></canvas>
  
  <div id="touchControls">
    <div class="touch-btn" id="touchLeft">‚Üê</div>
    <div class="touch-btn" id="touchUp">‚Üë</div>
    <div class="touch-btn" id="touchRight">‚Üí</div>
  </div>
  
  <!-- Transcend animation elements -->
  <div id="transcendAnimation" class="transcend-animation"></div>
</div>

<div id="ui">
  <div id="stats">
    <div class="stat-item">
      <span>üèÅ</span>
      <span>Distance: <span class="stat-value" id="distance">0</span> Peter Griffins</span>
    </div>
    <div class="stat-item">
      <span>ü•¨</span>
      <span>Lettuce: <span class="stat-value" id="money">0</span> lbs</span>
    </div>
    <div class="stat-item">
      <span>ü•§</span>
      <span>Lettuce Juice: <span class="stat-value" id="lettuceJuice">0</span> gallons</span>
    </div>
  </div>
  
  <div id="statsPanel">
    <div class="stat-card">
      <h3>Flights</h3>
      <div class="value" id="flights">0</div>
    </div>
  </div>
  
  <div id="controls">
    <div id="mainControls">
      <button id="launchBtn">fling thy mollusk</button>
      <button id="endFlightBtn" disabled>End Flight</button>
      <button id="rebirthBtn">Rebirth</button>
      <button id="resetProgressBtn">Reset Progress</button>
    </div>
    
    <div id="upgradeControls">
      <div class="upgrade-row">
        <button class="upgrade-btn" id="powerUpBtn">Strength of thy Snail<br><small>Cost: <span id="powerCost">10</span> lbs</small></button>
        <button class="upgrade-btn" id="gravityUpBtn">Reduce Gravity<br><small>Cost: <span id="gravityCost">15</span> lbs</small></button>
        <button class="upgrade-btn" id="airControlUpBtn"> Air Control<br><small>Cost: <span id="airControlCost">25</span> lbs</small></button>
        <button class="upgrade-btn" id="magnetUpBtn">More Coins<br><small>Cost: <span id="magnetCost">30</span> lbs</small></button>
      </div>
      <div class="upgrade-row">
        <button class="upgrade-btn" id="bounceUpBtn">Bounciness<br><small>Cost: <span id="bounceCost">50</span> lbs</small></button>
        <button class="upgrade-btn" id="windUpBtn">Wind Resistance<br><small>Cost: <span id="windCost">75</span> lbs</small></button>
        <button class="upgrade-btn" id="turboUpBtn">Turbo Boost<br><small>Cost: <span id="turboCost">100</span> lbs</small></button>
        <button class="upgrade-btn" id="luckyUpBtn">Lucky Charm<br><small>Cost: <span id="luckyCost">200</span> lbs</small></button>
      </div>
      <div class="upgrade-row">
        <button class="upgrade-btn" id="fatBtn">Fat<br><small>Cost: <span id="fatCost">1000000</span> lbs</small></button>
        <button class="upgrade-btn" id="speedForceBtn">Enter the Speed Force<br><small>Cost: <span id="speedForceCost">100000000</span> lbs</small></button>
        <button class="upgrade-btn" id="consumeVoidBtn">Consume the Void<br><small>Cost: <span id="consumeVoidCost">15000000</span> gallons</small></button>
      </div>
      <div class="upgrade-row">
        <button class="upgrade-btn rebirth" id="superStrengthBtn">Super Strength<br><small>Cost: <span id="superStrengthCost">1</span> gallon</small></button>
        <button class="upgrade-btn rebirth" id="wealthBtn">Wealth<br><small>Cost: <span id="wealthCost">5</span> gallons</small></button>
        <button class="upgrade-btn rebirth" id="choiceBtn">Choice Upgrade<br><small>Cost: <span id="choiceCost">10</span> gallons</small></button>
      </div>
    </div>
  </div>
</div>

<div id="rebirthModal">
  <div id="rebirthContent">
    <button id="cancelRebirthBtn">√ó</button>
    <h2>‚ú® Rebirth ‚ú®</h2>
    <p>You've earned <span id="lettuceJuiceEarned">0</span> gallons of lettuce juice!</p>
    <p>Rebirth resets all upgrades but keeps your lettuce juice!</p>
    <p>Each 250,000 lbs of lettuce = 1 gallon of juice</p>
    <button id="confirmRebirth">Confirm Rebirth</button>
  </div>
</div>

<div id="resetModal">
  <div id="resetContent">
    <h2>‚ö†Ô∏è Reset Progress ‚ö†Ô∏è</h2>
    <p>Are you sure you want to reset ALL progress?</p>
    <p>This will delete everything including lettuce juice!</p>
    <button id="cancelResetBtn">Cancel</button>
    <button id="confirmResetBtn">Confirm Reset</button>
  </div>
</div>

<div id="transcendMode">
  <h1>Transcendence</h1>
  <button id="transcendButton">Transcend</button>
  <div id="transcendInfo">
    <p>You've transcended the physical realm of lettuce and distance!</p>
    <p>Press the button to reset everything and start anew.</p>
  </div>
</div>

<div id="winScreen">
  <h1>üéâ You Win! üéâ</h1>
  <p>You have transcended the physical realm of lettuce and distance!</p>
  <button id="restartButton">Play Again</button>
</div>

<script>
(() => {
  // Save/load system
  const SAVE_KEY = 'flumgus_save';
  const CRASH_KEY = 'flumgus_crash';
  
  // Check for crash state
  const crashDetected = localStorage.getItem(CRASH_KEY) === 'true';
  if (crashDetected) {
    // Show transcend mode
    document.getElementById('transcendMode').classList.add('active');
    // Show "???\" for all stats
    document.getElementById('distance').textContent = '???';
    document.getElementById('money').textContent = '???';
    document.getElementById('lettuceJuice').textContent = '???';
    document.getElementById('flights').textContent = '???';
    
    // Disable all controls except transcend button
    document.querySelectorAll('#upgradeControls button, #mainControls button').forEach(btn => {
      btn.disabled = true;
    });
    
    // Add event listener to transcend button for crash recovery
    document.getElementById('transcendButton').addEventListener('click', () => {
      // Clear all save data
      localStorage.removeItem(SAVE_KEY);
      localStorage.removeItem(CRASH_KEY);
      
      // Reset to normal game state
      document.getElementById('transcendMode').classList.remove('active');
      document.getElementById('distance').textContent = '0';
      document.getElementById('money').textContent = '0';
      document.getElementById('lettuceJuice').textContent = '0';
      document.getElementById('flights').textContent = '0';
      
      // Re-enable all controls
      document.querySelectorAll('#upgradeControls button, #mainControls button').forEach(btn => {
        btn.disabled = false;
      });
      
      // Reset game state
      resetGame();
    });
    
    return; // Exit early to avoid initializing the game
  }
  
  // Set up crash detection
  window.addEventListener('beforeunload', () => {
    localStorage.setItem(CRASH_KEY, 'true');
  });
  
  // Clear crash flag on page load
  window.addEventListener('load', () => {
    localStorage.removeItem(CRASH_KEY);
  });
  
  // Save game state
  function saveGame() {
    const gameState = {
      money: money,
      lettuceJuice: lettuceJuice,
      distance: distance,
      speedForceActive: speedForceActive,
      catapultPower: catapultPower,
      gravity: gravity,
      airControl: airControl,
      coinMagnet: coinMagnet,
      bounceiness: bounceiness,
      windResistance: windResistance,
      turboBoost: turboBoost,
      luckyCharm: luckyCharm,
      snail: snail,
      cameraX: cameraX,
      cameraY: cameraY,
      totalEarned: totalEarned,
      totalDistance: totalDistance,
      bounceCount: bounceCount,
      maxDistance: maxDistance,
      totalFlights: totalFlights,
      rebirths: rebirths,
      superStrengthLevel: superStrengthLevel,
      wealthLevel: wealthLevel,
      choiceLevel: choiceLevel,
      consumeVoidActive: consumeVoidActive,
      fatActive: fatActive,
      achievements: achievements,
      snailCost: snailCost,
      snailUpgradeBought: snailUpgradeBought
    };
    
    localStorage.setItem(SAVE_KEY, JSON.stringify(gameState));
  }
  
  // Load game state
  function loadGame() {
    const saved = localStorage.getItem(SAVE_KEY);
    if (saved) {
      try {
        const gameState = JSON.parse(saved);
        
        // Restore all game state
        money = gameState.money;
        lettuceJuice = gameState.lettuceJuice;
        distance = gameState.distance;
        speedForceActive = gameState.speedForceActive;
        catapultPower = gameState.catapultPower;
        gravity = gameState.gravity;
        airControl = gameState.airControl;
        coinMagnet = gameState.coinMagnet;
        bounceiness = gameState.bounceiness;
        windResistance = gameState.windResistance;
        turboBoost = gameState.turboBoost;
        luckyCharm = gameState.luckyCharm;
        snail = gameState.snail;
        cameraX = gameState.cameraX;
        cameraY = gameState.cameraY;
        totalEarned = gameState.totalEarned;
        totalDistance = gameState.totalDistance;
        bounceCount = gameState.bounceCount;
        maxDistance = gameState.maxDistance;
        totalFlights = gameState.totalFlights;
        rebirths = gameState.rebirths;
        superStrengthLevel = gameState.superStrengthLevel;
        wealthLevel = gameState.wealthLevel;
        choiceLevel = gameState.choiceLevel;
        consumeVoidActive = gameState.consumeVoidActive;
        fatActive = gameState.fatActive;
        achievements = gameState.achievements;
        snailCost = gameState.snailCost;
        snailUpgradeBought = gameState.snailUpgradeBought;
        
        // Update UI
        updateMoney();
        updateLettuceJuice();
        updateDistance();
        updateStats();
        updateUpgradeButtons();
        
        // Update button states
        if (fatActive) {
          fatBtn.innerHTML = '‚öñÔ∏è Fat Snail<br><small>Owned!</small>';
          fatBtn.disabled = true;
        }
        
        if (speedForceActive) {
          speedForceBtn.innerHTML = '‚ö° Entered the Speed Force<br><small>Owned!</small>';
          speedForceBtn.disabled = true;
        }
        
        if (consumeVoidActive) {
          consumeVoidBtn.innerHTML = 'üåÄ Consumed the Void<br><small>Owned!</small>';
          consumeVoidBtn.disabled = true;
        }
        
        return true;
      } catch (e) {
        console.error('Failed to load game state:', e);
        return false;
      }
    }
    return false;
  }
  
  const canvas = document.getElementById('gameCanvas');
  const ctx = canvas.getContext('2d');

  const distanceSpan = document.getElementById('distance');
  const moneySpan = document.getElementById('money');
  const lettuceJuiceSpan = document.getElementById('lettuceJuice');
  const launchBtn = document.getElementById('launchBtn');
  const endFlightBtn = document.getElementById('endFlightBtn');
  const rebirthBtn = document.getElementById('rebirthBtn');
  const flightsSpan = document.getElementById('flights');
  const resetProgressBtn = document.getElementById('resetProgressBtn');

  const powerUpBtn = document.getElementById('powerUpBtn');
  const gravityUpBtn = document.getElementById('gravityUpBtn');
  const airControlUpBtn = document.getElementById('airControlUpBtn');
  const magnetUpBtn = document.getElementById('magnetUpBtn');
  const bounceUpBtn = document.getElementById('bounceUpBtn');
  const windUpBtn = document.getElementById('windUpBtn');
  const turboUpBtn = document.getElementById('turboUpBtn');
  const luckyUpBtn = document.getElementById('luckyUpBtn');
  const speedForceBtn = document.getElementById('speedForceBtn');
  const consumeVoidBtn = document.getElementById('consumeVoidBtn');
  const fatBtn = document.getElementById('fatBtn');
  const superStrengthBtn = document.getElementById('superStrengthBtn');
  const wealthBtn = document.getElementById('wealthBtn');
  const choiceBtn = document.getElementById('choiceBtn');

  // Touch controls
  const touchLeft = document.getElementById('touchLeft');
  const touchUp = document.getElementById('touchUp');
  const touchRight = document.getElementById('touchRight');

  // Rebirth modal
  const rebirthModal = document.getElementById('rebirthModal');
  const lettuceJuiceEarnedSpan = document.getElementById('lettuceJuiceEarned');
  const confirmRebirthBtn = document.getElementById('confirmRebirth');
  const cancelRebirthBtn = document.getElementById('cancelRebirthBtn');

  // Reset progress modal
  const resetModal = document.getElementById('resetModal');
  const cancelResetBtn = document.getElementById('cancelResetBtn');
  const confirmResetBtn = document.getElementById('confirmResetBtn');

  // Transcend elements
  const transcendMode = document.getElementById('transcendMode');
  const transcendButton = document.getElementById('transcendButton');
  const winScreen = document.getElementById('winScreen');
  const restartButton = document.getElementById('restartButton');
  const transcendAnimation = document.getElementById('transcendAnimation');

  // Game state variables
  let money = 0;
  let lettuceJuice = 0;
  let distance = 0;
  let speedForceActive = false;
  const speedForceMultiplier = 2.5e6;
  let catapultPower = 15;
  let catapultPowerCost = 10;

  let gravity = 0.8;
  let gravityCost = 15;

  let airControl = 0;
  let airControlCost = 25;

  let coinMagnet = 0;
  let magnetCost = 30;

  let bounceiness = 0.5;
  let bounceCost = 50;

  let windResistance = 1;
  let windCost = 75;

  let turboBoost = 0;
  let turboCost = 100;

  let luckyCharm = 0;
  let luckyCost = 200;

  let snailUpgradeBought = false;
  let achievements = {
  firstFlight: { unlocked: false, name: "First Flight", desc: "Launch your first snail", reward: 50 },
  distance100: { unlocked: false, name: "Century Mark", desc: "Travel 100 Peter Griffins", reward: 100 },
  distance500: { unlocked: false, name: "Long Hauler", desc: "Travel 500 Peter Griffins", reward: 250 },
  collector: { unlocked: false, name: "Lettuce Collector", desc: "Earn 1000 lbs of lettuce", reward: 500 },
  powerUp: { unlocked: false, name: "Power Hungry", desc: "Collect a power-up", reward: 75 },
  bouncer: { unlocked: false, name: "Bouncy Castle", desc: "Bounce 10 times in one flight", reward: 200 }
};

let totalEarned = 0;
let totalDistance = 0;
let bounceCount = 0;
let maxDistance = 0;
let totalFlights = 0;
let rebirths = 0;
const snailCost = 10000;

// Rebirth upgrade counters (these persist through rebirths)
let superStrengthLevel = 0;
let wealthLevel = 0;
let choiceLevel = 0;

let snail = {
  x: 100,
  y: 0,
  vx: 0,
  vy: 0,
  size: 40,
  flying: false,
};

let cameraX = 0;
let cameraY = 0;

let keys = {};
let touchKeys = {};
let clouds = [];
let powerUps = [];
let powerUpSpawnTimer = 0;

let landed = false;
let landTime = 0;
let waitingToReset = false;

// Initialize the display of the cost
const speedForceCostSpan = document.getElementById('speedForceCost');
speedForceCostSpan.textContent = (100000000).toLocaleString(); // 100 million

// Initialize the display of the consume void cost
const consumeVoidCostSpan = document.getElementById('consumeVoidCost');
consumeVoidCostSpan.textContent = (15000000).toLocaleString(); // 15 million gallons

// Initialize the display of the fat cost
const fatCostSpan = document.getElementById('fatCost');
fatCostSpan.textContent = (1000000).toLocaleString(); // 1 million

// Initialize rebirth upgrade costs
const superStrengthBaseCost = 1;
const wealthBaseCost = 5;
const choiceBaseCost = 10;

// Consume the Void upgrade variables
let consumeVoidActive = false;
const consumeVoidMultiplier = 25000000000000; // 25 trillion

// Fat upgrade variables
let fatActive = false;
const fatMultiplier = 3;
const fatCost = 1000000; // 1 million

// Particle system
let particles = [];

// Power-up elements
let powerUpElements = [];

// Resize canvas to fit container
function resizeCanvas() {
  const container = document.getElementById('gameContainer');
  const rect = container.getBoundingClientRect();
  canvas.width = rect.width - 16;
  canvas.height = Math.min(rect.height - 8, 400);
}

// Initialize clouds
function initClouds() {
  clouds = [];
  for (let i = 0; i < 15; i++) {
    clouds.push({
      x: Math.random() * 4000 - 1000,
      y: Math.random() * 200 + 50,
      size: Math.random() * 60 + 30,
      speed: Math.random() * 0.3 + 0.1,
      opacity: Math.random() * 0.4 + 0.3
    });
  }
}

function groundHeightAt(x) {
  return canvas.height - 60 + Math.sin(x * 0.01) * 20 + Math.sin(x * 0.03) * 5;
}

function spawnPowerUp() {
  if (snail.flying && Math.random() < 0.003) {
    const powerUp = {
      x: snail.x + canvas.width/2 + Math.random() * 200,
      y: 50 + Math.random() * 100,
      type: Math.random() < 0.5 ? 'speed' : 'bounce',
      collected: false,
      vy: 2 + Math.random() * 2,
      id: Date.now() + Math.random()
    };
    powerUps.push(powerUp);
    
    // Create visual element
    const powerUpElement = document.createElement('div');
    powerUpElement.className = `power-up ${powerUp.type}-power`;
    powerUpElement.style.left = `${powerUp.x - cameraX}px`;
    powerUpElement.style.top = `${powerUp.y - cameraY}px`;
    document.getElementById('gameContainer').appendChild(powerUpElement);
    powerUpElements.push({ element: powerUpElement, id: powerUp.id });
  }
}

function resetSnail() {
  snail.x = 100;
  snail.y = groundHeightAt(snail.x) - snail.size;
  snail.vx = 0;
  snail.vy = 0;
  snail.flying = false;
  landed = false;
  waitingToReset = false;
  distance = 0;
  updateDistance();
  cameraX = snail.x - canvas.width / 3;
  cameraY = snail.y - canvas.height / 2;
  endFlightBtn.disabled = true;
  
  // Remove power-ups
  powerUps = [];
  powerUpElements.forEach(el => el.element.remove());
  powerUpElements = [];
}

function endFlight() {
  if (!snail.flying) return;
  
  let reward = Math.floor(distance * (1 + coinMagnet * 0.5));
  
  if (luckyCharm > 0 && Math.random() < luckyCharm * 0.1) {
    reward *= 2;
  }
  
  money += reward;
  updateMoney();
  resetSnail();
}

// Create particle effect
function createParticles(x, y, color, count) {
  for (let i = 0; i < count; i++) {
    particles.push({
      x: x,
      y: y,
      size: Math.random() * 5 + 2,
      speedX: (Math.random() - 0.5) * 4,
      speedY: (Math.random() - 0.5) * 4,
      color: color,
      life: 30
    });
  }
}

// Update particles
function updateParticles() {
  for (let i = particles.length - 1; i >= 0; i--) {
    const p = particles[i];
    p.x += p.speedX;
    p.y += p.speedY;
    p.life--;
    
    if (p.life <= 0) {
      particles.splice(i, 1);
    }
  }
}

// Draw particles
function drawParticles() {
  particles.forEach(p => {
    ctx.globalAlpha = p.life / 30;
    ctx.fillStyle = p.color;
    ctx.beginPath();
    ctx.arc(p.x - cameraX, p.y - cameraY, p.size, 0, Math.PI * 2);
    ctx.fill();
  });
  ctx.globalAlpha = 1;
}

// Touch control setup
function setupTouchControls() {
  const touchEvents = ['touchstart', 'touchend', 'touchcancel'];
  
  touchEvents.forEach(eventType => {
    touchLeft.addEventListener(eventType, (e) => {
      e.preventDefault();
      touchKeys['ArrowLeft'] = eventType === 'touchstart';
    });
    
    touchRight.addEventListener(eventType, (e) => {
      e.preventDefault();
      touchKeys['ArrowRight'] = eventType === 'touchstart';
    });
    
    touchUp.addEventListener(eventType, (e) => {
      e.preventDefault();
      touchKeys['ArrowUp'] = eventType === 'touchstart';
    });
  });

  [touchLeft, touchRight, touchUp].forEach(btn => {
    btn.addEventListener('contextmenu', (e) => e.preventDefault());
  });
}

// Initialize game
resizeCanvas();
resetSnail();
initClouds();
setupTouchControls();

// Load game state if available
loadGame();

// Save game periodically
setInterval(saveGame, 30000); // Save every 30 seconds

launchBtn.onclick = () => {
  if (snail.flying) return;
  // Apply rebirth upgrade effects
  let effectivePower = catapultPower;
  if (superStrengthLevel > 0) {
    effectivePower *= Math.pow(2, superStrengthLevel);
  }
  snail.vx = effectivePower + (Math.random() * 5 - 2.5);
  snail.vy = -(effectivePower * 1.3) + (Math.random() * 5 - 2.5);
  snail.flying = true;
  landed = false;
  waitingToReset = false;
  distance = 0;
  updateDistance();
  endFlightBtn.disabled = false;
  totalFlights++;
  updateStats();
};

endFlightBtn.onclick = endFlight;

// Rebirth functionality
rebirthBtn.onclick = () => {
  // Calculate lettuce juice earned (1 gallon per 250,000 lbs)
  const juiceEarned = Math.floor(money / 250000);
  lettuceJuiceEarnedSpan.textContent = juiceEarned;
  rebirthModal.classList.add('active');
};

cancelRebirthBtn.onclick = () => {
  rebirthModal.classList.remove('active');
};

confirmRebirthBtn.onclick = () => {
  // Calculate lettuce juice earned (1 gallon per 250,000 lbs)
  const juiceEarned = Math.floor(money / 250000);
  lettuceJuice += juiceEarned;
  
  // Reset regular upgrades but keep rebirth upgrades
  money = 0;
  catapultPower = 15;
  gravity = 0.8;
  airControl = 0;
  coinMagnet = 0;
  bounceiness = 0.5;
  windResistance = 1;
  turboBoost = 0;
  luckyCharm = 0;
  speedForceActive = false;
  consumeVoidActive = false;
  fatActive = false;
  snail.size = 40;
  
  // Reset upgrade costs
  catapultPowerCost = 10;
  gravityCost = 15;
  airControlCost = 25;
  magnetCost = 30;
  bounceCost = 50;
  windCost = 75;
  turboCost = 100;
  luckyCost = 200;
  
  // Update UI
  updateMoney();
  updateLettuceJuice();
  updateUpgradeButtons();
  
  // Close modal
  rebirthModal.classList.remove('active');
  
  // Create visual effect
  createParticles(snail.x, snail.y, '#ffd700', 50);
  
  // Update rebirth count
  rebirths++;
  updateStats();
};

// Reset progress functionality
resetProgressBtn.onclick = () => {
  resetModal.classList.add('active');
};

cancelResetBtn.onclick = () => {
  resetModal.classList.remove('active');
};

confirmResetBtn.onclick = () => {
  // Clear all save data
  localStorage.removeItem(SAVE_KEY);
  localStorage.removeItem(CRASH_KEY);
  
  // Reset to normal game state
  resetModal.classList.remove('active');
  document.getElementById('distance').textContent = '0';
  document.getElementById('money').textContent = '0';
  document.getElementById('lettuceJuice').textContent = '0';
  document.getElementById('flights').textContent = '0';
  
  // Reset game state
  resetGame();
};

// Transcend functionality
transcendButton.onclick = () => {
  // Hide transcend mode
  transcendMode.classList.remove('active');
  
  // Show transcend animation
  showTranscendAnimation();
};

function showTranscendAnimation() {
  // Create transcend animation elements
  transcendAnimation.style.display = 'block';
  
  // Create snail element
  const snailElement = document.createElement('div');
  snailElement.className = 'transcend-snail';
  snailElement.textContent = 'üêå';
  snailElement.style.left = `${snail.x - cameraX}px`;
  snailElement.style.top = `${snail.y - cameraY}px`;
  transcendAnimation.appendChild(snailElement);
  
  // Create glow effect
  const glowElement = document.createElement('div');
  glowElement.className = 'transcend-glow';
  glowElement.style.left = `${snail.x - cameraX - 50}px`;
  glowElement.style.top = `${snail.y - cameraY - 50}px`;
  transcendAnimation.appendChild(glowElement);
  
  // Animate the snail
  setTimeout(() => {
    // Remove the animation elements
    transcendAnimation.innerHTML = '';
    transcendAnimation.style.display = 'none';
    
    // Show win screen
    winScreen.classList.add('active');
  }, 2000);
}

restartButton.onclick = () => {
  // Clear all save data
  localStorage.removeItem(SAVE_KEY);
  localStorage.removeItem(CRASH_KEY);
  
  // Reset to normal game state
  winScreen.classList.remove('active');
  document.getElementById('distance').textContent = '0';
  document.getElementById('money').textContent = '0';
  document.getElementById('lettuceJuice').textContent = '0';
  document.getElementById('flights').textContent = '0';
  
  // Reset game state
  resetGame();
};

function update(delta) {
  let speedMultiplier = 1;
  if (speedForceActive) speedMultiplier = speedForceMultiplier;
  if (consumeVoidActive) speedMultiplier = consumeVoidMultiplier;
  
  clouds.forEach(cloud => {
    cloud.x += cloud.speed;
    if (cloud.x > cameraX + canvas.width + 200) {
      cloud.x = cameraX - 200;
      cloud.y = Math.random() * 200 + 50;
    }
  });

  if (!snail.flying) return;

  if (airControl > 0) {
    const leftPressed = keys['ArrowLeft'] || touchKeys['ArrowLeft'];
    const rightPressed = keys['ArrowRight'] || touchKeys['ArrowRight'];
    const upPressed = keys['ArrowUp'] || touchKeys['ArrowUp'];
    
    if (leftPressed) snail.vx -= airControl * 0.3 * speedMultiplier;
    if (rightPressed) snail.vx += airControl * 0.3 * speedMultiplier;
    if (upPressed && turboBoost > 0) snail.vy -= turboBoost * 0.2;
  }

  snail.vx += (Math.random() * 0.2 - 0.1) * windResistance * speedMultiplier;
  snail.vy += gravity * speedMultiplier + (Math.random() * 0.2 - 0.1);
  snail.x += snail.vx;
  snail.y += snail.vy;

  const currentGroundY = groundHeightAt(snail.x);
  if (snail.y + snail.size > currentGroundY) {
    snail.y = currentGroundY - snail.size;
    snail.vx *= 0.6;
    snail.vy = -snail.vy * bounceiness;
    bounceCount++;

    if (!landed && Math.abs(snail.vy) < 1) {
      landed = true;
      landTime = performance.now();

      let reward = Math.floor(distance * (1 + coinMagnet * 0.5));
      
      if (luckyCharm > 0 && Math.random() < luckyCharm * 0.1) {
        reward *= 2;
      }
      
      // Apply wealth rebirth upgrade
      if (wealthLevel > 0) {
        reward *= Math.pow(3, wealthLevel);
      }
      
      money += reward;
      updateMoney();
    }
  }

  if (landed && !waitingToReset) {
    if (Math.abs(snail.vx) < 0.1) {
      waitingToReset = true;
      landTime = performance.now();
    }
  }

  if (waitingToReset) {
    if (performance.now() - landTime > 1000) {
      resetSnail();
    }
  }

  distance = (snail.x - 100) / snail.size;
  if (distance < 0) distance = 0;

  updateDistance();

  const leadAhead = snail.vx * 5;
  const targetCamX = snail.x - canvas.width / 3 + leadAhead;
  const targetCamY = snail.y - canvas.height / 2 + snail.vy * 2;
  
  cameraX += (targetCamX - cameraX) * 0.08;
  cameraY += (targetCamY - cameraY) * 0.06;
  
  // Update power-up positions
  powerUpElements.forEach(el => {
    const powerUp = powerUps.find(p => p.id === el.id);
    if (powerUp) {
      el.element.style.left = `${powerUp.x - cameraX}px`;
      el.element.style.top = `${powerUp.y - cameraY}px`;
    }
  });
}

function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
  gradient.addColorStop(0, '#87ceeb');
  gradient.addColorStop(0.7, '#b8e6ff');
  gradient.addColorStop(1, '#e0f6ff');
  ctx.fillStyle = gradient;
  ctx.fillRect(0, 0, canvas.width, canvas.height);

  ctx.save();
  clouds.forEach(cloud => {
    const cloudX = cloud.x - cameraX;
    const cloudY = cloud.y - cameraY * 0.3;
    
    if (cloudX > -cloud.size && cloudX < canvas.width + cloud.size) {
      ctx.globalAlpha = cloud.opacity;
      ctx.fillStyle = 'white';
      ctx.beginPath();
      
      for (let i = 0; i < 6; i++) {
        const angle = (i / 6) * Math.PI * 2;
        const radius = cloud.size * (0.7 + Math.sin(angle * 3) * 0.3);
        const x = cloudX + Math.cos(angle) * radius * 0.5;
        const y = cloudY + Math.sin(angle) * radius * 0.3;
        
        if (i === 0) ctx.moveTo(x, y);
        else ctx.lineTo(x, y);
      }
      ctx.closePath();
      ctx.fill();
    }
  });
  ctx.restore();

  ctx.fillStyle = '#6b8e23';
  ctx.beginPath();
  ctx.moveTo(0, canvas.height);
  const startSegment = Math.floor(cameraX / 50) - 1;
  const endSegment = startSegment + Math.ceil(canvas.width / 50) + 3;
  for (let seg = startSegment; seg <= endSegment; seg++) {
    const segX = seg * 50 - cameraX;
    const segY = groundHeightAt(seg * 50) - cameraY;
    ctx.lineTo(segX, segY);
  }
  ctx.lineTo(canvas.width, canvas.height);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = '#9acd32';
  for (let seg = startSegment; seg <= endSegment; seg += 2) {
    const segX = seg * 50 - cameraX;
    const segY = groundHeightAt(seg * 50) - cameraY;
    if (segX > -20 && segX < canvas.width + 20) {
      ctx.fillRect(segX - 2, segY - 8, 4, 8);
      ctx.fillRect(segX + 8, segY - 6, 3, 6);
      ctx.fillRect(segX - 8, segY - 5, 2, 5);
    }
  }

  if (snail.flying) {
    ctx.shadowColor = '#ffff00';
    ctx.shadowBlur = 15;
  }
  
  // Make snail completely black when consume the void is active
  if (consumeVoidActive) {
    ctx.fillStyle = '#000000';
  } else {
    ctx.fillStyle = '#9acd32';
  }
  
  ctx.font = `${snail.size}px serif`;
  ctx.textBaseline = 'top';
  const snailScreenX = snail.x - cameraX;
  const snailScreenY = snail.y - cameraY;
  ctx.fillText('üêå', snailScreenX, snailScreenY);
  
  ctx.shadowBlur = 0;

  if (snail.flying && Math.abs(snail.vx) > 8) {
    ctx.strokeStyle = 'rgba(255, 255, 255, 0.6)';
    ctx.lineWidth = 2;
    for (let i = 0; i < 5; i++) {
      const lineX = snailScreenX - (i + 1) * 10;
      const lineY = snailScreenY + snail.size/2 + (Math.random() - 0.5) * 20;
      ctx.beginPath();
      ctx.moveTo(lineX, lineY);
      ctx.lineTo(lineX - 15, lineY);
      ctx.stroke();
    }
  }
  
  // Draw particles
  drawParticles();
}

function gameLoop(t) {
  if (!lastTime) lastTime = t;
  const delta = (t - lastTime) / 16.666;
  lastTime = t;

  update(delta);
  updateParticles();
  draw();

  requestAnimationFrame(gameLoop);
}

function updateDistance() {
  distanceSpan.textContent = distance.toFixed(2);
}

function updateMoney() {
  moneySpan.textContent = money;
  updateUpgradeButtons();
}

function updateLettuceJuice() {
  lettuceJuiceSpan.textContent = lettuceJuice;
  updateUpgradeButtons();
}

function updateStats() {
  flightsSpan.textContent = totalFlights;
}

function checkAchievements() {
  const ach = achievements;
  
  if (!ach.firstFlight.unlocked && totalFlights >= 1) {
    unlockAchievement('firstFlight');
  }
  
  if (!ach.distance100.unlocked && maxDistance >= 100) {
    unlockAchievement('distance100');
  }
  
  if (!ach.distance500.unlocked && maxDistance >= 500) {
    unlockAchievement('distance500');
  }
  
  if (!ach.collector.unlocked && totalEarned >= 1000) {
    unlockAchievement('collector');
  }
  
  if (!ach.bouncer.unlocked && bounceCount >= 10) {
    unlockAchievement('bouncer');
  }
}

function unlockAchievement(key) {
  const ach = achievements[key];
  if (!ach.unlocked) {
    ach.unlocked = true;
    money += ach.reward;
    showAchievementNotification(ach);
    updateMoney();
  }
}

function showAchievementNotification(achievement) {
  // Create notification element
  const notification = document.createElement('div');
  notification.id = 'achievementNotification';
  notification.style.cssText = `
    position: fixed; top: 20px; right: 20px; z-index: 9999;
    background: linear-gradient(135deg, #ffd700, #ffed4e);
    color: #2d3748; padding: 12px 16px; border-radius: 8px;
    box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    font-weight: 600; font-size: 14px; min-width: 250px;
    transform: translateX(300px); transition: transform 0.3s ease;
  `;
  notification.innerHTML = `
    üèÜ <strong>${achievement.name}</strong><br>
    <small>${achievement.desc}</small><br>
    <small>+${achievement.reward} lbs lettuce!</small>
  `;
  
  document.body.appendChild(notification);
  
  setTimeout(() => notification.style.transform = 'translateX(0)', 100);
  setTimeout(() => notification.style.transform = 'translateX(300px)', 4000);
  setTimeout(() => document.body.removeChild(notification), 4500);
}

// Upgrade button handlers
powerUpBtn.onclick = () => {
  if (money >= catapultPowerCost) {
    money -= catapultPowerCost;
    catapultPower += 5;
    catapultPowerCost = Math.floor(catapultPowerCost * 1.4);
    powerUpBtn.querySelector('#powerCost').textContent = catapultPowerCost;
    updateMoney();
  }
};

gravityUpBtn.onclick = () => {
  if (money >= gravityCost && gravity > 0.2) {
    money -= gravityCost;
    gravity -= 0.1;
    gravityCost = Math.floor(gravityCost * 1.4);
    gravityUpBtn.querySelector('#gravityCost').textContent = gravityCost;
    updateMoney();
  }
};

airControlUpBtn.onclick = () => {
  if (money >= airControlCost) {
    money -= airControlCost;
    airControl += 0.3;
    airControlCost = Math.floor(airControlCost * 1.4);
    airControlUpBtn.querySelector('#airControlCost').textContent = airControlCost;
    updateMoney();
  }
};

magnetUpBtn.onclick = () => {
  if (money >= magnetCost) {
    money -= magnetCost;
    coinMagnet += 1;
    magnetCost = Math.floor(magnetCost * 1.4);
    magnetUpBtn.querySelector('#magnetCost').textContent = magnetCost;
    updateMoney();
  }
};

bounceUpBtn.onclick = () => {
  if (money >= bounceCost) {
    money -= bounceCost;
    bounceiness += 0.2;
    bounceCost = Math.floor(bounceCost * 1.4);
    bounceUpBtn.querySelector('#bounceCost').textContent = bounceCost;
    updateMoney();
  }
};

windUpBtn.onclick = () => {
  if (money >= windCost) {
    money -= windCost;
    windResistance -= 0.1;
    windCost = Math.floor(windCost * 1.4);
    windUpBtn.querySelector('#windCost').textContent = windCost;
    updateMoney();
  }
};

turboUpBtn.onclick = () => {
  if (money >= turboCost) {
    money -= turboCost;
    turboBoost += 1;
    turboCost = Math.floor(turboCost * 1.4);
    turboUpBtn.querySelector('#turboCost').textContent = turboCost;
    updateMoney();
  }
};

luckyUpBtn.onclick = () => {
  if (money >= luckyCost) {
    money -= luckyCost;
    luckyCharm += 1;
    luckyCost = Math.floor(luckyCost * 1.5);
    luckyUpBtn.querySelector('#luckyCost').textContent = luckyCost;
    updateMoney();
  }
};

// Fat button handler
fatBtn.onclick = () => {
  if (money >= fatCost && !fatActive) {
    money -= fatCost;
    fatActive = true;
    snail.size *= fatMultiplier;
    fatBtn.innerHTML = '‚öñÔ∏è Fat Snail<br><small>Owned!</small>';
    fatBtn.disabled = true;
    updateMoney();
    updateUpgradeButtons();
  }
};

// Speed Force button handler
speedForceBtn.onclick = () => {
  if (money >= 100000000 && !speedForceActive) {
    money -= 100000000;
    speedForceActive = true;
    speedForceBtn.innerHTML = '‚ö° Entered the Speed Force<br><small>Owned!</small>';
    speedForceBtn.disabled = true;
    updateMoney();
    updateUpgradeButtons();
  }
};

// Consume the Void button handler
consumeVoidBtn.onclick = () => {
  if (lettuceJuice >= 15000000 && !consumeVoidActive) {
    lettuceJuice -= 15000000;
    consumeVoidActive = true;
    consumeVoidBtn.innerHTML = 'üåÄ Consumed the Void<br><small>Owned!</small>';
    consumeVoidBtn.disabled = true;
    updateLettuceJuice();
    updateUpgradeButtons();
  }
};

// Rebirth upgrade handlers
superStrengthBtn.onclick = () => {
  const cost = superStrengthBaseCost * Math.pow(2, superStrengthLevel);
  if (lettuceJuice >= cost) {
    lettuceJuice -= cost;
    superStrengthLevel++;
    superStrengthBtn.querySelector('#superStrengthCost').textContent = cost * 2;
    updateLettuceJuice();
    updateUpgradeButtons();
    
    // Create visual effect
    createParticles(snail.x, snail.y, '#9370db', 30);
  }
};

wealthBtn.onclick = () => {
  const cost = wealthBaseCost * Math.pow(2, wealthLevel);
  if (lettuceJuice >= cost) {
    lettuceJuice -= cost;
    wealthLevel++;
    wealthBtn.querySelector('#wealthCost').textContent = cost * 2;
    updateLettuceJuice();
    updateUpgradeButtons();
    
    // Create visual effect
    createParticles(snail.x, snail.y, '#9370db', 40);
  }
};

choiceBtn.onclick = () => {
  const cost = choiceBaseCost * Math.pow(2, choiceLevel);
  if (lettuceJuice >= cost) {
    lettuceJuice -= cost;
    choiceLevel++;
    choiceBtn.querySelector('#choiceCost').textContent = cost * 2;
    updateLettuceJuice();
    updateUpgradeButtons();
    
    // Create visual effect
    createParticles(snail.x, snail.y, '#9370db', 50);
  }
};

function updateUpgradeButtons() {
  powerUpBtn.disabled = money < catapultPowerCost;
  gravityUpBtn.disabled = money < gravityCost || gravity <= 0.2;
  airControlUpBtn.disabled = money < airControlCost;
  magnetUpBtn.disabled = money < magnetCost;
  bounceUpBtn.disabled = money < bounceCost;
  windUpBtn.disabled = money < windCost || windResistance <= 0.3;
  turboUpBtn.disabled = money < turboCost;
  luckyUpBtn.disabled = money < luckyCost;
  fatBtn.disabled = money < fatCost || fatActive;
  speedForceBtn.disabled = money < 100000000 || speedForceActive;
  consumeVoidBtn.disabled = lettuceJuice < 15000000 || consumeVoidActive;
  
  // Rebirth upgrades
  const superStrengthCost = superStrengthBaseCost * Math.pow(2, superStrengthLevel);
  const wealthCost = wealthBaseCost * Math.pow(2, wealthLevel);
  const choiceCost = choiceBaseCost * Math.pow(2, choiceLevel);
  
  superStrengthBtn.disabled = lettuceJuice < superStrengthCost;
  wealthBtn.disabled = lettuceJuice < wealthCost;
  choiceBtn.disabled = lettuceJuice < choiceCost;
  
  // Update cost displays
  superStrengthBtn.querySelector('#superStrengthCost').textContent = superStrengthCost;
  wealthBtn.querySelector('#wealthCost').textContent = wealthCost;
  choiceBtn.querySelector('#choiceCost').textContent = choiceCost;
}

// Keyboard input
window.addEventListener('keydown', (e) => {
  keys[e.key] = true;
});
  
window.addEventListener('keyup', (e) => {
  keys[e.key] = false;
});

// Window resize handler
window.addEventListener('resize', () => {
  setTimeout(resizeCanvas, 100);
});

// Prevent double-tap zoom
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) {
    event.preventDefault();
  }
  lastTouchEnd = now;
}, false);

let lastTime;
updateUpgradeButtons();
requestAnimationFrame(gameLoop);

// Reset game function for transcend mode
function resetGame() {
  // Reset all game variables to initial state
  money = 0;
  lettuceJuice = 0;
  distance = 0;
  speedForceActive = false;
  catapultPower = 15;
  gravity = 0.8;
  airControl = 0;
  coinMagnet = 0;
  bounceiness = 0.5;
  windResistance = 1;
  turboBoost = 0;
  luckyCharm = 0;
  snailUpgradeBought = false;
  achievements = {
    firstFlight: { unlocked: false, name: "First Flight", desc: "Launch your first snail", reward: 50 },
    distance100: { unlocked: false, name: "Century Mark", desc: "Travel 100 Peter Griffins", reward: 100 },
    distance500: { unlocked: false, name: "Long Hauler", desc: "Travel 500 Peter Griffins", reward: 250 },
    collector: { unlocked: false, name: "Lettuce Collector", desc: "Earn 1000 lbs of lettuce", reward: 500 },
    powerUp: { unlocked: false, name: "Power Hungry", desc: "Collect a power-up", reward: 75 },
    bouncer: { unlocked: false, name: "Bouncy Castle", desc: "Bounce 10 times in one flight", reward: 200 }
  };
  totalEarned = 0;
  totalDistance = 0;
  bounceCount = 0;
  maxDistance = 0;
  totalFlights = 0;
  rebirths = 0;
  superStrengthLevel = 0;
  wealthLevel = 0;
  choiceLevel = 0;
  consumeVoidActive = false;
  fatActive = false;
  
  // Reset upgrade costs
  catapultPowerCost = 10;
  gravityCost = 15;
  airControlCost = 25;
  magnetCost = 30;
  bounceCost = 50;
  windCost = 75;
  turboCost = 100;
  luckyCost = 200;
  
  // Reset UI
  updateMoney();
  updateLettuceJuice();
  updateDistance();
  updateStats();
  updateUpgradeButtons();
  
  // Reset snail
  resetSnail();
  
  // Reset buttons
  fatBtn.innerHTML = 'Fat<br><small>Cost: <span id=\"fatCost\">1000000</span> lbs</small>';
  fatBtn.disabled = false;
  speedForceBtn.innerHTML = 'Enter the Speed Force<br><small>Cost: <span id=\"speedForceCost\">100000000</span> lbs</small>';
  speedForceBtn.disabled = false;
  consumeVoidBtn.innerHTML = 'Consume the Void<br><small>Cost: <span id=\"consumeVoidCost\">15000000</span> gallons</small>';
  consumeVoidBtn.disabled = false;
  
  // Reset clouds
  initClouds();
}

})();
</script>

</body>
</html>
